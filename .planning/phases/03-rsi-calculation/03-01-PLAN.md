---
phase: 03-rsi-calculation
plan: 01
type: execute
---

<objective>
Implement RSI calculation module for daily and weekly timeframes.

Purpose: Convert CoinGecko historical price data into RSI values for visualization
Output: Working `src/rsi.py` module with calculate_rsi, get_daily_rsi, get_weekly_rsi functions
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/02-coingecko-integration/02-01-SUMMARY.md

# Source files:
@src/coingecko.py
@src/rsi.py

**Tech stack available:** httpx, asyncio, Streamlit, Plotly
**Established patterns:** async context manager, concurrent gather with error handling
**Data format from CoinGecko:** `get_coin_market_chart()` returns `{'prices': [[timestamp_ms, price], ...], ...}` with daily granularity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement core RSI calculation</name>
  <files>src/rsi.py</files>
  <action>
Implement `calculate_rsi(closes: list[float], period: int = 14) -> float | None`:
- Uses Wilder's smoothed RSI formula (standard 14-period)
- Returns None if insufficient data (need period + 1 prices minimum)
- Algorithm:
  1. Calculate price changes (deltas)
  2. Separate gains (positive) and losses (negative, as positive values)
  3. First average: simple mean of first `period` gains/losses
  4. Subsequent: smoothed = (prev_avg * (period-1) + current) / period
  5. RS = avg_gain / avg_loss (handle zero loss case)
  6. RSI = 100 - (100 / (1 + RS))
- Return the latest RSI value (0-100 range)
- Do NOT use pandas - keep it pure Python for simplicity
  </action>
  <verify>
Import module: `python -c "from src.rsi import calculate_rsi; print(calculate_rsi([44, 44.34, 44.09, 43.61, 44.33, 44.83, 45.10, 45.42, 45.84, 46.08, 45.89, 46.03, 45.61, 46.28, 46.28, 46.00]))"`
Expected output: ~70 (classic RSI example data)
  </verify>
  <done>calculate_rsi function returns valid RSI values matching standard formula</done>
</task>

<task type="auto">
  <name>Task 2: Implement daily RSI extraction</name>
  <files>src/rsi.py</files>
  <action>
Implement `get_daily_rsi(market_chart: dict, period: int = 14) -> float | None`:
- Takes CoinGecko market_chart response (from get_coin_market_chart)
- Extracts daily closing prices from `market_chart['prices']` (list of [timestamp_ms, price])
- Calls calculate_rsi with the price list
- Returns RSI value or None if insufficient data

Also implement `extract_closes(market_chart: dict) -> list[float]`:
- Helper to extract just the price values from the market_chart format
- Returns list of floats (closing prices, oldest to newest)
  </action>
  <verify>
python -c "from src.rsi import get_daily_rsi; print(get_daily_rsi({'prices': [[1,100],[2,102],[3,101],[4,103],[5,105],[6,104],[7,106],[8,108],[9,107],[10,109],[11,111],[12,110],[13,112],[14,114],[15,113],[16,115]]}))"
Should return a float RSI value
  </verify>
  <done>get_daily_rsi extracts prices from CoinGecko format and returns RSI</done>
</task>

<task type="auto">
  <name>Task 3: Implement weekly RSI calculation</name>
  <files>src/rsi.py</files>
  <action>
Implement `get_weekly_rsi(market_chart: dict, period: int = 14) -> float | None`:
- Takes CoinGecko market_chart response (daily data, typically 90 days)
- Aggregates to weekly closes: group by week, take last close of each week
- Week boundary: use Monday as start (standard)
- Algorithm:
  1. Extract daily [timestamp_ms, price] pairs
  2. Convert timestamps to datetime, group by ISO week (year, week_number)
  3. For each week, take the last (most recent) close
  4. Calculate RSI on weekly closes
- Need at least 15 weeks of data (14 period + 1)

Implementation note:
- Use datetime.fromtimestamp(ts/1000) for timestamp conversion
- Use .isocalendar() for week grouping
- Return None if <15 weekly data points
  </action>
  <verify>
python -c "
from src.rsi import get_weekly_rsi
import time
# Create 100 days of fake data (enough for weekly aggregation)
now = time.time() * 1000
day_ms = 86400000
prices = [[now - day_ms * (100-i), 100 + i*0.5 + (i%7)*0.1] for i in range(100)]
result = get_weekly_rsi({'prices': prices})
print(f'Weekly RSI: {result}')
"
Should return a float RSI value
  </verify>
  <done>get_weekly_rsi aggregates daily to weekly and calculates RSI correctly</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.rsi import calculate_rsi, get_daily_rsi, get_weekly_rsi"` imports without error
- [ ] calculate_rsi returns expected value for known test data
- [ ] get_daily_rsi processes CoinGecko format correctly
- [ ] get_weekly_rsi aggregates and calculates correctly
- [ ] All functions handle edge cases (None for insufficient data)
</verification>

<success_criteria>

- All 3 functions implemented and working
- RSI values in 0-100 range
- Handles edge cases gracefully (returns None, not crash)
- Ready for integration with visualization phase
  </success_criteria>

<output>
After completion, create `.planning/phases/03-rsi-calculation/03-01-SUMMARY.md`
</output>
