---
phase: 08-funding-integration
plan: 01
type: execute
---

<objective>
Build async Binance Futures client to fetch funding rates and open interest for perpetual contracts.

Purpose: Provide futures positioning data (funding + OI) for coins that have perpetual markets, enabling crowded trade detection.
Output: New `src/funding.py` module with BinanceFundingClient class and symbol mapping.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-funding-integration/DISCOVERY.md
@src/coingecko.py

**From Phase 7:**
- All data layer calculations in `src/indicators.py`
- Sector classification in `src/sectors.py`
- Opportunity scoring formula expects `funding_aligned` confluence factor

**API Details (from DISCOVERY.md):**
- Binance base: `https://fapi.binance.com`
- `/fapi/v1/premiumIndex` - current funding rates (all symbols if no symbol param)
- `/futures/data/openInterestHist` - historical OI
- Symbol format: `{SYMBOL}USDT` (e.g., BTCUSDT)
- No API key required for market data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Binance Funding Client</name>
  <files>src/funding.py</files>
  <action>
Create new `src/funding.py` module with `BinanceFundingClient` class following CoinGecko client pattern:

1. Class with `__init__` setting base_url to `https://fapi.binance.com`
2. `async _request(endpoint, params)` method using httpx.AsyncClient
3. `async get_all_funding_rates()` method:
   - Call `/fapi/v1/premiumIndex` (no symbol = all symbols)
   - Return dict mapping symbol -> FundingData (lastFundingRate, nextFundingTime, markPrice)
4. `async get_funding_for_symbols(symbols: list[str])` method:
   - Input: list of uppercase symbols like ["BTC", "ETH"]
   - Convert to exchange format: f"{symbol}USDT"
   - Fetch all funding rates once
   - Filter to requested symbols
   - Return dict mapping original symbol -> funding data (or None if not found)
5. Add `symbol_to_exchange()` helper: uppercases and appends USDT
6. Add `exchange_to_symbol()` helper: removes USDT suffix
7. Context manager methods (__aenter__, __aexit__) for proper cleanup

Handle API errors gracefully - return empty dict on failure, don't crash.
  </action>
  <verify>
Run: `python -c "import asyncio; from src.funding import BinanceFundingClient; client = BinanceFundingClient(); print(asyncio.run(client.get_funding_for_symbols(['BTC', 'ETH'])))"`
Should return dict with funding data for BTC and ETH.
  </verify>
  <done>
- BinanceFundingClient class exists with async methods
- get_funding_for_symbols returns funding rates for valid symbols
- Invalid symbols return None without crashing
- Client follows same pattern as CoinGeckoClient
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Open Interest Fetching</name>
  <files>src/funding.py</files>
  <action>
Extend BinanceFundingClient with open interest methods:

1. `async get_open_interest(symbol: str)` method:
   - Call `/futures/data/openInterestHist` with symbol={symbol}USDT, period="1h", limit=24
   - Return list of OI data points (sumOpenInterest, sumOpenInterestValue, timestamp)
   - Handle 404/empty gracefully (return empty list)

2. `async get_open_interest_change(symbol: str)` method:
   - Get last 24 hours of OI data
   - Calculate: current OI, 24h change %, direction (increasing/decreasing/stable)
   - Return dict: {current_oi, change_24h_pct, direction}
   - Use thresholds: >5% = increasing, <-5% = decreasing, else stable

3. Add helper function `create_symbol_mapping(coin_ids: list[dict])`:
   - Input: list of coins from watchlist.json with "id" and "symbol" fields
   - Output: dict mapping CoinGecko ID -> exchange symbol (e.g., "bitcoin" -> "BTCUSDT")
   - This bridges the gap between CoinGecko IDs and Binance symbols
  </action>
  <verify>
Run: `python -c "import asyncio; from src.funding import BinanceFundingClient; client = BinanceFundingClient(); print(asyncio.run(client.get_open_interest_change('BTC')))"`
Should return dict with current_oi, change_24h_pct, and direction.
  </verify>
  <done>
- get_open_interest returns historical OI data
- get_open_interest_change returns OI change metrics
- create_symbol_mapping bridges CoinGecko IDs to exchange symbols
- Graceful handling of coins without perp markets
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.funding import BinanceFundingClient, create_symbol_mapping"` succeeds
- [ ] Funding rates fetch works for BTC, ETH
- [ ] Open interest data returns for symbols with perps
- [ ] No API errors for symbols without perps (graceful None return)
</verification>

<success_criteria>

- src/funding.py exists with BinanceFundingClient class
- Funding rate fetching works for all watchlist symbols with perps
- Open interest change calculation implemented
- Symbol mapping utility bridges CoinGecko IDs to exchange symbols
- All methods follow async pattern matching project conventions
</success_criteria>

<output>
After completion, create `.planning/phases/08-funding-integration/08-01-SUMMARY.md`
</output>
