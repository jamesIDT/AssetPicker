---
phase: 08-funding-integration
plan: 02
type: execute
---

<objective>
Build positioning matrix from funding+OI data and add confluence detection to indicators module.

Purpose: Combine funding rates and open interest into crowded positioning signals, then integrate with RSI confluence scoring.
Output: Complete funding rate integration with positioning detection and RSI alignment.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-funding-integration/DISCOVERY.md
@.planning/phases/08-funding-integration/08-01-PLAN.md
@src/funding.py
@src/indicators.py

**Positioning Logic (from roadmap):**
- High positive funding (> 0.03%) = crowded long
- High negative funding (< -0.03%) = crowded short
- Large OI increase + extreme funding = potential squeeze

**Confluence Logic (from Phase 14):**
- RSI oversold (< 30) AND funding negative = bullish confluence (+0.2)
- RSI overbought (> 70) AND funding positive = bearish confluence (+0.2)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Positioning Matrix</name>
  <files>src/funding.py</files>
  <action>
Add positioning analysis functions to src/funding.py:

1. `calculate_positioning(funding_rate: float, oi_change_pct: float | None)` function:
   - Input: funding rate (decimal), OI change % (optional)
   - Returns dict with:
     - `crowded`: "long" | "short" | "neutral"
     - `crowded_score`: 0-100 intensity (0=neutral, 100=extreme)
     - `squeeze_risk`: "high" | "medium" | "low" | None
   - Logic:
     - funding > 0.0003 (0.03%) = crowded long
     - funding < -0.0003 = crowded short
     - Score based on funding intensity: abs(funding) / 0.001 * 100 (capped at 100)
     - squeeze_risk "high" if crowded AND oi_change > 10%
     - squeeze_risk "medium" if crowded AND oi_change > 5%

2. `async get_positioning_for_coins(client: BinanceFundingClient, symbols: list[str])` function:
   - Fetch funding rates for all symbols
   - Fetch OI changes for all symbols (in parallel)
   - Return dict mapping symbol -> PositioningData with:
     - funding_rate
     - oi_change_24h
     - crowded
     - crowded_score
     - squeeze_risk
   - Use asyncio.gather for parallel fetches

3. Add dataclass or TypedDict for `PositioningData` to formalize the structure.
  </action>
  <verify>
Run: `python -c "from src.funding import calculate_positioning; print(calculate_positioning(0.0005, 15.0))"`
Should return: {'crowded': 'long', 'crowded_score': 50, 'squeeze_risk': 'high'}
  </verify>
  <done>
- calculate_positioning returns crowded status and squeeze risk
- get_positioning_for_coins fetches data for multiple symbols efficiently
- PositioningData structure documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Funding Confluence Detection</name>
  <files>src/indicators.py</files>
  <action>
Add funding confluence detection to src/indicators.py:

1. `detect_funding_confluence(daily_rsi: float, funding_rate: float | None)` function:
   - Input: daily RSI value, funding rate (can be None)
   - Returns dict with:
     - `aligned`: bool (True if funding confirms RSI signal)
     - `type`: "bullish" | "bearish" | None
     - `strength`: "strong" | "moderate" | "weak" | None
   - Logic:
     - If funding_rate is None: return {aligned: False, type: None, strength: None}
     - Bullish: RSI < 30 AND funding < 0 (shorts paying longs = potential bottom)
     - Bearish: RSI > 70 AND funding > 0 (longs paying shorts = potential top)
     - Strength based on funding intensity:
       - abs(funding) > 0.0005 = strong
       - abs(funding) > 0.0002 = moderate
       - else = weak

2. Update `calculate_opportunity_score()` to accept optional `funding_aligned: bool` parameter:
   - If funding_aligned is True, add +0.2 to confluence multiplier (per Phase 14 spec)
   - Default to False if not provided (backwards compatible)

3. Add helper `get_confluence_factors(daily_rsi, weekly_rsi, funding_rate, has_divergence, volatility_compressed, sector_turning)`:
   - Aggregates all confluence factors into a dict
   - Returns: {weekly_extreme, divergence, funding_aligned, volatility_compressed, sector_turning}
   - Matches the calculate_opportunity_score expected inputs
  </action>
  <verify>
Run: `python -c "from src.indicators import detect_funding_confluence; print(detect_funding_confluence(25.0, -0.0006))"`
Should return: {'aligned': True, 'type': 'bullish', 'strength': 'strong'}

Run: `python -c "from src.indicators import detect_funding_confluence; print(detect_funding_confluence(45.0, 0.0001))"`
Should return: {'aligned': False, 'type': None, 'strength': None}
  </verify>
  <done>
- detect_funding_confluence correctly identifies RSI-funding alignment
- calculate_opportunity_score accepts funding_aligned parameter
- get_confluence_factors aggregates all factors for opportunity scoring
- Phase 8 deliverables complete: Funding Fetcher, OI Changes, Positioning Matrix, Confluence Detection
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.funding import calculate_positioning, get_positioning_for_coins"` succeeds
- [ ] `python -c "from src.indicators import detect_funding_confluence, get_confluence_factors"` succeeds
- [ ] Bullish confluence detected for oversold RSI with negative funding
- [ ] Bearish confluence detected for overbought RSI with positive funding
- [ ] calculate_opportunity_score works with funding_aligned parameter
</verification>

<success_criteria>

- Positioning matrix correctly identifies crowded trades
- Squeeze risk calculated from funding + OI combination
- Funding confluence detection integrated with RSI signals
- Opportunity scoring accepts funding alignment factor
- All Phase 8 roadmap deliverables complete:
  1. ✅ Funding Rate Fetcher
  2. ✅ Open Interest Changes
  3. ✅ Positioning Matrix
  4. ✅ Confluence Detection
</success_criteria>

<output>
After completion, create `.planning/phases/08-funding-integration/08-02-SUMMARY.md`
</output>
