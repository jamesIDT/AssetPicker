---
phase: 26-polish-performance
plan: 01
type: execute
---

<objective>
Optimize ring rendering performance and handle edge cases for multi-timeframe divergence display.

Purpose: Ensure v4.0 renders smoothly with full 48-coin dataset and gracefully handles missing data.
Output: Performance-validated, edge-case-hardened multi-TF visualization.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-divergence-matrix/25-01-SUMMARY.md
@.planning/2025-01-25-multi-timeframe-divergence-display.md

**Key context:**
- Ring rendering: 6 SVG shapes per coin Ã— 48 coins = 288 shapes per chart
- Success criteria from spec: chart renders in <2 seconds with 48 coins
- Current implementation uses fig.add_shape() for each arc segment
- multi_tf_divergence data may be missing for some coins (no hourly data)

**Source files:**
@src/charts.py - build_rsi_scatter with ring rendering (lines 517-594)
@app.py - main dashboard, multi_tf_divergence handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add performance measurement and test full dataset</name>
  <files>app.py</files>
  <action>
Add timing instrumentation around build_rsi_scatter() calls to measure render time with multi_tf_divergence enabled:
1. Import time module at top
2. Before calling build_rsi_scatter, capture start time
3. After call returns, log elapsed time (use st.write in a debug expander or just capture for now)
4. Run the app with full 48-coin dataset and verify ring rendering works
5. Capture baseline timing

If render time exceeds 2 seconds target, note for next task. If under 2 seconds, we're good on performance.

NOTE: After measuring, remove the timing code (this is just for verification, not production).
  </action>
  <verify>App runs successfully with multi_tf_divergence rings visible on scatter plot. Timing captured.</verify>
  <done>Baseline render time measured. Rings render correctly for all coins with divergence data.</done>
</task>

<task type="auto">
  <name>Task 2: Add graceful handling for missing multi-TF data</name>
  <files>src/charts.py, app.py</files>
  <action>
Ensure robust handling when multi_tf_divergence data is incomplete or missing:

In charts.py build_rsi_scatter():
1. Already checks `if multi_tf_divergence:` before rendering - good
2. Already checks `if not coin_id: continue` - good
3. Add explicit handling when a coin has no entry in multi_tf_divergence dict:
   - Currently handled via .get(coin_id, {}) which returns empty dict - OK
4. Add handling for individual timeframe missing:
   - Currently handled via coin_mtf.get(tf, {}) - OK
   - Ensure div_type defaults to "none" if tf_data is empty - already done

In app.py:
1. Verify multi_tf_divergence is always initialized (even as empty dict) after data refresh
2. Handle case where hourly_history is None but daily data exists:
   - In calculate_multi_tf_divergence, if hourly is empty, only 1d/3d/1w should have data
   - Check if current implementation handles this

Test by:
- Running with coins that have no hourly data (check if 1d/3d/1w still show)
- Running with fresh install (no cached hourly data)
  </action>
  <verify>App handles edge cases: coins with no hourly data show only daily timeframe rings, no errors on empty data.</verify>
  <done>Edge cases handled gracefully. No crashes or rendering errors with partial data.</done>
</task>

<task type="auto">
  <name>Task 3: Polish loading states and add multi-TF data status</name>
  <files>app.py</files>
  <action>
Improve user feedback for multi-TF data state:

1. In the divergence matrix section, if multi_tf_divergence is empty dict (not None but {}):
   - Show "Calculating divergences..." or similar message

2. In the subheader after "Data from CoinGecko Pro API":
   - Add indicator if hourly data is stale or missing
   - Format: "Hourly data: [status]" where status = "Fresh", "Stale (Xh ago)", or "Missing"

3. In the sidebar controls area:
   - If no multi_tf_divergence data available, disable (or note) the Timeframe Highlight selector

Keep changes minimal - don't over-engineer.
  </action>
  <verify>Loading states and status indicators display correctly. Users understand when multi-TF data is available.</verify>
  <done>Loading states and data status indicators added. Clear feedback for multi-TF data availability.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] App runs without errors with full 48-coin dataset
- [ ] Ring segments render correctly on scatter plot
- [ ] Divergence matrix displays correctly
- [ ] No crashes with missing/partial hourly data
- [ ] Render time is acceptable (target <2s, acceptable <3s)
- [ ] Loading states provide clear feedback
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Ring rendering performs within acceptable bounds
- Edge cases handled gracefully
- v4.0 multi-timeframe divergence feature is production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/26-polish-performance/26-01-SUMMARY.md`
</output>
