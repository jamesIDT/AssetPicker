---
phase: 07-data-layer-extensions
plan: 04
type: execute
---

<objective>
Build signal lifecycle classification and opportunity decay score calculation.

Purpose: Complete the data layer with signal aging and composite scoring that Phase 14 (Opportunity Leaderboard) will consume.
Output: Extended `src/indicators.py` with lifecycle and decay score functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior plan context:**
@.planning/phases/07-data-layer-extensions/07-03-SUMMARY.md

**Existing code:**
@src/rsi.py
@src/indicators.py
@src/sectors.py

**Phase 14 score formula (for reference):**
```
Score = Base_Score x Freshness_Multiplier x Confluence_Multiplier

Where:
Base_Score = abs(Z-score of RSI)
Freshness = 1.0 if signal < 3 days, decay to 0.3 at 14+ days
Confluence = 1.0 + sum of:
  - Weekly RSI also extreme: +0.2
  - Divergence present: +0.3 (or +0.5 for multi-TF)
  - Positive decorrelation: +0.2
  - Volatility compressed: +0.2
  - Sector turning: +0.1
  - Funding alignment: +0.2
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Signal Lifecycle State</name>
  <files>src/indicators.py</files>
  <action>
Add signal lifecycle classification to `src/indicators.py`.

Implement `classify_signal_lifecycle(rsi_history: list[float], extreme_threshold: float = 30.0, is_oversold: bool = True) -> dict | None`:
- Input:
  - rsi_history: RSI values (oldest to newest)
  - extreme_threshold: RSI level for extreme (30 for oversold, 70 for overbought)
  - is_oversold: True for oversold signals, False for overbought
- Output: Dict with keys:
  - `state`: "fresh" | "confirmed" | "extended" | "resolving" | "none"
  - `days_in_zone`: How many consecutive periods in extreme zone
  - `entry_rsi`: RSI when signal started
  - `current_rsi`: Current RSI
  - `emoji`: State emoji for UI display

Logic:
1. Scan from end of history backward to find consecutive extreme readings
2. Classification:
   - "none": Current RSI not in extreme zone
   - "fresh": In zone for 1-2 days
   - "confirmed": In zone for 3-5 days
   - "extended": In zone for 6+ days
   - "resolving": Was in zone but now moving toward 50 (crossed back within last 2 periods)

3. For oversold: extreme = RSI < threshold
   For overbought: extreme = RSI > threshold

4. Emoji mapping:
   - fresh: "new"
   - confirmed: "checkmark"
   - extended: "hourglass"
   - resolving: "arrow_up" (for oversold) or "arrow_down" (for overbought)
   - none: ""

Return None if insufficient history (< 5 values).
  </action>
  <verify>
Test in REPL:
```python
from src.indicators import classify_signal_lifecycle

# Fresh signal (just entered oversold)
history = [50, 45, 40, 35, 28]
result = classify_signal_lifecycle(history, 30.0, True)
assert result["state"] == "fresh"
assert result["days_in_zone"] == 1

# Confirmed signal (in zone 3-5 days)
history = [50, 45, 28, 26, 25]
result = classify_signal_lifecycle(history, 30.0, True)
assert result["state"] == "confirmed"
assert result["days_in_zone"] == 3
```
  </verify>
  <done>Function classifies signal lifecycle with days in zone and state emoji</done>
</task>

<task type="auto">
  <name>Task 2: Opportunity Decay Score</name>
  <files>src/indicators.py</files>
  <action>
Add opportunity scoring to `src/indicators.py`.

Implement `calculate_opportunity_score(factors: dict) -> dict`:
- Input: Dict with optional keys (missing factors = neutral contribution):
  - `zscore`: Z-score of RSI (from calculate_zscore)
  - `days_in_zone`: Days signal has been active
  - `weekly_extreme`: True if weekly RSI also in extreme
  - `divergence_score`: 0/1/2/4 from calculate_divergence_score
  - `volatility_compressed`: True if volatility regime is "compressed"
  - `sector_turning`: True if sector RSI is turning (from sector analysis)
  - `funding_aligned`: True if funding rate aligns with signal (future Phase 8)
  - `decorrelation_positive`: True if coin decorrelated favorably from BTC

- Output: Dict with keys:
  - `base_score`: abs(zscore) or 1.0 if no zscore
  - `freshness_multiplier`: 1.0 to 0.3 based on days_in_zone
  - `confluence_multiplier`: 1.0 + sum of factor bonuses
  - `final_score`: base * freshness * confluence
  - `factors`: Dict showing contribution of each factor

Freshness decay curve:
- days 0-2: 1.0
- days 3-6: 0.8
- days 7-10: 0.6
- days 11-13: 0.4
- days 14+: 0.3

Confluence bonuses (per roadmap):
- weekly_extreme: +0.2
- divergence_score 1-2: +0.3
- divergence_score 4: +0.5
- volatility_compressed: +0.2
- sector_turning: +0.1
- funding_aligned: +0.2
- decorrelation_positive: +0.2
  </action>
  <verify>
Test in REPL:
```python
from src.indicators import calculate_opportunity_score

# High conviction opportunity
factors = {
    "zscore": -2.5,
    "days_in_zone": 2,
    "weekly_extreme": True,
    "divergence_score": 4,
    "volatility_compressed": True,
}
result = calculate_opportunity_score(factors)
# base = 2.5, freshness = 1.0, confluence = 1.0 + 0.2 + 0.5 + 0.2 = 1.9
# final = 2.5 * 1.0 * 1.9 = 4.75
assert result["final_score"] > 4.0
assert result["confluence_multiplier"] >= 1.9

# Stale opportunity
factors = {"zscore": -2.0, "days_in_zone": 14}
result = calculate_opportunity_score(factors)
assert result["freshness_multiplier"] == 0.3
assert result["final_score"] < 1.0
```
  </verify>
  <done>Function calculates composite opportunity score with decay and confluence factors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All new functions importable from src/indicators.py
- [ ] Signal lifecycle handles both oversold and overbought
- [ ] Opportunity score handles missing factors gracefully
- [ ] Final score formula matches Phase 14 roadmap spec
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Signal lifecycle and opportunity score functions complete
- Phase 7: Data Layer Extensions is complete
- Ready for Phase 8: Funding Rate Integration
</success_criteria>

<output>
After completion, create `.planning/phases/07-data-layer-extensions/07-04-SUMMARY.md` with:
- All 10 calculations from Phase 7 complete
- New modules: src/indicators.py, src/sectors.py
- Phase 7 complete, ready for Phase 8
</output>
