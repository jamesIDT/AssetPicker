---
phase: 14-opportunity-leaderboard
plan: 01
type: execute
---

<objective>
Create the Opportunity Leaderboard ‚Äî a ranked table integrating all Phase 7-13 factors into a composite decay score.

Purpose: Provide a single view that ranks all coins by opportunity score, making it easy to identify the best signals across all dimensions.
Output: New "Opportunity Leaderboard" expander with ranked table, score breakdown, bull/bear tabs, and filters.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-data-layer-extensions/07-04-SUMMARY.md

# Key files to reference:
@src/indicators.py - calculate_opportunity_score(), get_confluence_factors(), classify_signal_lifecycle(), calculate_zscore()
@src/sectors.py - get_sector(), calculate_sector_momentum()
@app.py - fetch_all_data(), existing expander patterns (Signal Lifecycle, Sector Momentum, Acceleration Quadrant)

**Tech stack available:** Streamlit, Plotly, pandas (already used in app.py for tables)
**Established patterns:**
- Expander sections for detailed views
- pandas DataFrames for tabular display
- Existing fetch_all_data() calculates all needed indicators

**Score formula from roadmap:**
```
Score = Base_Score √ó Freshness_Multiplier √ó Confluence_Multiplier

Where:
Base_Score = abs(Z-score of RSI)
Freshness = 1.0 if signal < 3 days, decay to 0.3 at 14+ days
Confluence = 1.0 + sum of:
  - Weekly RSI also extreme: +0.2
  - Divergence present: +0.3 (or +0.5 for multi-TF)
  - Positive decorrelation: +0.2
  - Volatility compressed: +0.2
  - Sector turning: +0.1
  - Funding alignment: +0.2
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calculate opportunity scores in fetch_all_data</name>
  <files>app.py</files>
  <action>
In fetch_all_data(), after calculating all existing indicators, add opportunity score calculation for each coin:

1. Import `calculate_opportunity_score`, `get_confluence_factors` from indicators (already imported)
2. For each coin in the result loop, after all other calculations:
   - Get zscore from zscore_info (if available)
   - Get days_in_zone from lifecycle_oversold or lifecycle_overbought
   - Check weekly_extreme: weekly_rsi < 30 or > 70
   - Get divergence_score from divergence_result (use index matching)
   - Check volatility_compressed: volatility.regime == "compressed"
   - Check sector_turning: need to calculate sector momentum first, then check if coin's sector has is_rotation_signal
   - Check funding_aligned: not implemented yet (no funding data in current app), set False
   - Check decorrelation_positive: beta_info.interpretation == "outperforming" (for oversold) or "underperforming" (for overbought)
3. Build factors dict and call calculate_opportunity_score()
4. Add "opportunity_score" to each coin dict with the full score result
5. Add "signal_direction" key: "long" if daily_rsi < 50 else "short"

Note: Sector momentum needs to be calculated earlier (before the result loop) so we can check is_rotation_signal per sector. Move sector_rsi and sector_momentum calculation to before the result loop.
  </action>
  <verify>
Start app with `streamlit run app.py`, click Refresh, verify no errors in console.
Print a few coins' opportunity_score in debug to confirm calculation works.
  </verify>
  <done>
Each coin in result has "opportunity_score" dict with base_score, freshness_multiplier, confluence_multiplier, final_score, and factors.
Each coin has "signal_direction" ("long" or "short").
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Opportunity Leaderboard expander UI</name>
  <files>app.py</files>
  <action>
Add new expander section after Acceleration Quadrant:

```python
with st.expander("üèÜ Opportunity Leaderboard", expanded=False):
```

Inside the expander:

1. **Signal direction tabs:**
   - Create tabs: "Long Opportunities (Oversold)", "Short Opportunities (Overbought)"
   - Filter coins by signal_direction for each tab

2. **Quick filters (in columns above table):**
   - Sector filter dropdown (reuse sector_options pattern)
   - Minimum score slider (0.0 to 5.0, step 0.5)
   - Max signal age slider (1 to 14+ days)

3. **Ranked table:**
   - Sort by final_score descending (highest first)
   - Columns: Rank, Symbol, Sector, Score, Base, Fresh, Conflu, Factors
   - "Factors" column: show emoji icons for active factors (e.g., "üìÖ" weekly, "üìâ" divergence, "‚ö°" compressed, "üîÑ" sector, "üí∞" funding)
   - Use pandas DataFrame with st.dataframe()
   - Color-code score column (green for high scores, yellow for medium)

4. **Expandable score breakdown:**
   - Use st.expander per row OR show factor details in tooltip
   - Simpler: show factors as comma-separated list or icons

5. **Explanatory footer:**
   - st.caption with formula explanation
   - "Higher score = stronger opportunity signal"
   - Factor icons legend

Format table for readability:
- Round scores to 2 decimal places
- Use fixed column widths where possible
- Limit to top 20 by default, with "Show all" toggle
  </action>
  <verify>
Start app, click Refresh, expand Opportunity Leaderboard:
- Verify Long/Short tabs work
- Verify filters update table
- Verify scores are calculated and sorted correctly
- Verify factor icons display
  </verify>
  <done>
Opportunity Leaderboard expander shows ranked table with:
- Long/Short tabs
- Sector, min score, max age filters
- Sortable table with score breakdown
- Factor icons and explanatory footer
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `streamlit run app.py` runs without errors
- [ ] Refresh loads data and calculates opportunity scores
- [ ] Opportunity Leaderboard shows ranked coins
- [ ] Long/Short tabs filter correctly
- [ ] Filters work (sector, min score, max age)
- [ ] Score formula matches roadmap spec
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Opportunity scores calculated using all available factors
- Leaderboard provides actionable ranking of opportunities
- Phase 14 complete ‚Äî v2.0 Advanced Screening milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-opportunity-leaderboard/14-01-SUMMARY.md`
</output>
