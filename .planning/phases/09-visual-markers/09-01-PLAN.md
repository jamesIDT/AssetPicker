---
phase: 09-visual-markers
plan: 01
type: execute
---

<objective>
Implement custom divergence marker system on the scatter plot.

Purpose: Visually distinguish coins with bullish/bearish divergence and show signal strength through marker shape and layering.
Output: Enhanced scatter plot with divergence icons (+, diamond), score-based layering, legend, and divergence tooltip details.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (divergence scoring):
@.planning/phases/07-data-layer-extensions/07-03-SUMMARY.md

# Key source files:
@src/charts.py
@src/indicators.py

**Tech stack available:** Plotly, Streamlit, pure Python
**Established patterns:** customdata for tooltips, vrect zone shading, RdYlGn_r colorscale for weekly RSI
**Divergence functions available:**
- `detect_divergence(price_history, rsi_history)` → type: bullish|bearish|none, strength: 1|2
- `score_divergence(daily_div, weekly_div)` → 0|1|2|4

**Visual encoding spec from roadmap:**
- Bullish divergence: Plus sign (+) shape
- Bearish divergence: Diamond (◆) shape
- Score 1 (single TF, weak): Bold inner shape only
- Score 2 (single TF, strong): Bold inner + thin outer ring
- Score 4 (multi-TF confluence): Bold inner + bold outer ring
- Neutral (no divergence): Standard circle
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add divergence marker shapes and layering</name>
  <files>src/charts.py</files>
  <action>
Modify `build_rsi_scatter()` to accept divergence data and render different marker shapes:

1. Add new parameter: `divergence_data: list[dict] | None = None` containing per-coin divergence info:
   - `type`: "bullish" | "bearish" | "none"
   - `score`: 0 | 1 | 2 | 4

2. Replace single scatter trace with multiple traces for layered rendering:
   - Base layer: Standard circles for all coins (size 10)
   - Overlay for score >= 2: Thin outer ring (size 16, open circle)
   - Overlay for score = 4: Bold outer ring (size 16, thicker line)
   - Top layer: Shape based on divergence type:
     - `none` → circle (symbol="circle")
     - `bullish` → cross (symbol="cross") - Plotly's cross is + shape
     - `bearish` → diamond (symbol="diamond")

3. Use Plotly marker symbols:
   - "circle" for neutral
   - "cross" for bullish (renders as +)
   - "diamond" for bearish

4. Maintain existing color encoding (weekly RSI via RdYlGn_r colorscale).

5. Group coins by divergence type to minimize traces - max 6 traces total:
   - Background circles (all coins, for outer rings)
   - Outer ring trace for score >= 2
   - Bold ring trace for score = 4
   - Neutral circles trace
   - Bullish crosses trace
   - Bearish diamonds trace

Avoid: Creating a separate trace per coin (performance issue). Use vectorized approach.
  </action>
  <verify>
Import charts.py without error:
`python -c "from src.charts import build_rsi_scatter; print('OK')"`
  </verify>
  <done>
- Function accepts divergence_data parameter
- Divergence shapes render correctly (+ for bullish, diamond for bearish)
- Score layering visible (outer rings for score 2+, bold rings for score 4)
- Color encoding still works (weekly RSI)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add divergence legend and enhance tooltips</name>
  <files>src/charts.py</files>
  <action>
1. Add legend explaining divergence markers:
   - Position: Top-left corner using annotations
   - Content:
     ```
     + Bullish Divergence
     ◆ Bearish Divergence
     ○ No Divergence
     Ring = Score 2+
     Bold Ring = Score 4
     ```
   - Use small font (10-11px), subtle background, don't overlap data

2. Enhance tooltip (hovertemplate) to include divergence info:
   - Add to customdata: divergence_type, divergence_score
   - Update hovertemplate to show:
     ```
     <b>Name</b> (SYMBOL)
     Price: $X
     ...existing fields...
     Divergence: {type} (score {score})
     ```
   - For "none" type, show "Divergence: None" or omit entirely

3. Keep legend entries visible but unobtrusive. Use `legendgroup` to group related traces.
  </action>
  <verify>
Run test data through chart builder and verify tooltip content:
`python -c "
from src.charts import build_rsi_scatter
test_data = [{'symbol': 'BTC', 'name': 'Bitcoin', 'daily_rsi': 45, 'weekly_rsi': 50, 'vol_mcap_ratio': 0.05, 'price': 50000, 'volume': 1e9, 'market_cap': 1e12}]
div_data = [{'type': 'bullish', 'score': 2}]
fig = build_rsi_scatter(test_data, div_data)
print('Traces:', len(fig.data))
print('Has legend:', any(t.showlegend for t in fig.data))
"`
  </verify>
  <done>
- Legend visible in top-left explaining marker shapes
- Tooltips show divergence type and score
- Legend doesn't overlap chart data area
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire divergence data into app.py</name>
  <files>app.py</files>
  <action>
1. Import divergence functions if not already imported:
   `from src.indicators import detect_divergence, score_divergence`

2. After fetching coin data and calculating RSI:
   - For each coin, call `detect_divergence()` on daily data
   - Call `detect_divergence()` on weekly data
   - Call `score_divergence(daily_div, weekly_div)` to get combined score
   - Build divergence_data list: `[{"type": div_type, "score": score}, ...]`

3. Pass divergence_data to `build_rsi_scatter(coin_data, divergence_data)`.

4. Handle edge cases:
   - If divergence detection returns None (insufficient data), treat as type="none", score=0
   - Match divergence_data order to coin_data order

Avoid: Breaking existing functionality if divergence data is unavailable. Make divergence_data optional with graceful fallback.
  </action>
  <verify>
Run the Streamlit app and visually confirm divergence markers appear:
`streamlit run app.py --server.headless true &
sleep 3
curl -s http://localhost:8501 | grep -q "Streamlit" && echo "App running"
pkill -f streamlit`
  </verify>
  <done>
- App runs without errors
- Divergence markers visible on scatter plot for coins with divergence
- Coins without divergence show standard circles
- Tooltip shows divergence info on hover
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.charts import build_rsi_scatter; print('OK')"` succeeds
- [ ] App starts without errors: `streamlit run app.py --server.headless true`
- [ ] Divergence shapes visible: + for bullish, diamond for bearish
- [ ] Score layering works: outer rings for score 2+, bold for score 4
- [ ] Legend visible and explains marker meanings
- [ ] Tooltips include divergence type and score
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Visual marker system distinguishes divergence types at a glance
- Users can identify high-conviction signals (score 4) immediately
</success_criteria>

<output>
After completion, create `.planning/phases/09-visual-markers/09-01-SUMMARY.md` with:
- Performance metrics
- Files created/modified
- Visual encoding decisions made
- Any issues encountered
</output>
