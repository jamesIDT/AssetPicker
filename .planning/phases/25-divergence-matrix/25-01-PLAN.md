---
phase: 25-divergence-matrix
plan: 01
type: execute
---

<objective>
Build divergence analysis matrix showing multi-timeframe divergence status per coin.

Purpose: Provide a sortable grid view of divergences across all 6 timeframes, enabling quick identification of coins with multiple divergence alignments.
Output: Always-visible matrix component with colored cells, sorting by divergence count, and hover tooltips.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/2025-01-25-multi-timeframe-divergence-display.md

# Key prior work:
@.planning/phases/22-multi-timeframe-candles/22-01-SUMMARY.md
@.planning/phases/23-segmented-ring-viz/23-01-SUMMARY.md
@.planning/phases/24-timeframe-highlight/24-01-SUMMARY.md

# Source files:
@src/charts.py
@app.py

**Data available:**
- `st.session_state.multi_tf_divergence[coin_id]` - dict with keys: "1h", "4h", "12h", "1d", "3d", "1w"
- Each value: `{"type": "bullish"/"bearish"/"none", "strength": 1/2, "description": "..."}`

**Color scheme (from charts.py):**
- Bullish: #22c55e (green)
- Bearish: #ef4444 (red)
- None: #6b7280 (gray)

**Timeframe display order:**
- Matrix columns: 1h, 4h, 12h, 1d, 3d, 1w (left to right, ascending significance)
- Spec says "most at top" for row sorting (by total divergence count)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create divergence matrix builder function</name>
  <files>src/charts.py</files>
  <action>
Add function `build_divergence_matrix(coin_data: list[dict], multi_tf_divergence: dict) -> tuple[list[dict], list[str]]` that:

1. Build matrix data:
   - Iterate through coins that have multi_tf_divergence data
   - For each coin, count total divergences (type != "none") across 6 timeframes
   - Create row dict with: symbol, 1h, 4h, 12h, 1d, 3d, 1w columns, total count, detailed tooltips

2. Sort rows by total divergence count descending, then alphabetically by symbol

3. Return tuple of (matrix_data, column_order) where:
   - matrix_data: List of dicts ready for DataFrame
   - column_order: ["Symbol", "1h", "4h", "12h", "1d", "3d", "1w", "Total"]

Cell format for each timeframe column should be a dict with:
- "value": emoji (ðŸŸ¢ bullish, ðŸ”´ bearish, âšª none)
- "type": "bullish"/"bearish"/"none"
- "tooltip": divergence description if available

Example output row:
{
    "symbol": "BTC",
    "1h": {"value": "ðŸŸ¢", "type": "bullish", "tooltip": "Bullish divergence: price lower low..."},
    "4h": {"value": "âšª", "type": "none", "tooltip": ""},
    ...
    "total": 3
}

Use existing DIVERGENCE_COLORS dict for consistency (for future styling needs).
Place this function near the other chart builders in charts.py.
  </action>
  <verify>Function can be imported and called: `python -c "from src.charts import build_divergence_matrix; print('OK')"`</verify>
  <done>Function returns properly structured matrix data from multi_tf_divergence</done>
</task>

<task type="auto">
  <name>Task 2: Add divergence matrix to app layout</name>
  <files>app.py</files>
  <action>
1. Import build_divergence_matrix from src.charts

2. Add new section after "CHARTS â€” MARKET OVERVIEW" section, before "ANALYSIS â€” OPPORTUNITIES":

```python
# Section Header: Divergence Analysis
st.markdown(
    '<div class="section-header">DIVERGENCE ANALYSIS â€” MULTI-TIMEFRAME</div>',
    unsafe_allow_html=True,
)

st.markdown('<div class="bordered-panel">', unsafe_allow_html=True)
```

3. Build and display the matrix using Streamlit's st.dataframe:
   - Call build_divergence_matrix with coin_data and multi_tf_divergence from session state
   - Filter to only show coins with at least 1 divergence (total > 0) by default
   - Add checkbox "Show all coins" to toggle filter
   - Use st.dataframe with column_config to style columns

4. Style the dataframe:
   - Use custom column widths (Symbol wider, TF columns narrow)
   - Apply background colors to cells based on divergence type using Pandas Styler if needed
   - Or use markdown/HTML table for full color control

5. Add caption explaining the matrix:
   "ðŸŸ¢ Bullish (price lower low, RSI higher low) | ðŸ”´ Bearish (price higher high, RSI lower high) | âšª None"

6. Close panel: `st.markdown('</div>', unsafe_allow_html=True)`

Position: After the charts row (chart_col1/chart_col2 block), before the Analysis section header.

Implementation detail: Since st.dataframe doesn't support per-cell background colors easily, use emoji indicators (ðŸŸ¢ðŸ”´âšª) which are clear and match the design aesthetic. The "Total" column helps users quickly sort by divergence count.
  </action>
  <verify>Run `streamlit run app.py` and verify: (1) Divergence matrix section appears between charts and analysis, (2) Matrix shows coins with divergence counts, (3) Emoji colors match divergence types, (4) "Show all" toggle works</verify>
  <done>Divergence matrix is visible in UI, sorted by total count, cells show colored indicators</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.charts import build_divergence_matrix"` succeeds
- [ ] App runs without errors: `streamlit run app.py`
- [ ] Matrix section appears in correct position (after charts, before analysis)
- [ ] Matrix shows coins sorted by divergence count (descending)
- [ ] Cell colors match: ðŸŸ¢ bullish, ðŸ”´ bearish, âšª none
- [ ] "Show all" checkbox toggles between filtered/full view
</verification>

<success_criteria>

- build_divergence_matrix function created and working
- Matrix component visible in dashboard layout
- Coins sorted by total divergence count
- Visual indicators clear (emoji or colored cells)
- No runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/25-divergence-matrix/25-01-SUMMARY.md`:

# Phase 25 Plan 01: Divergence Matrix Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/charts.py` - Added build_divergence_matrix function
- `app.py` - Added divergence matrix section

## Decisions Made

[Any decisions about implementation approach]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 26: Polish & Performance]
</output>
