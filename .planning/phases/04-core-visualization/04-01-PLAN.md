---
phase: 04-core-visualization
plan: 01
type: execute
---

<objective>
Interactive Plotly scatter plot showing daily RSI vs liquidity with weekly RSI color encoding.

Purpose: Create the core visualization that enables at-a-glance identification of RSI extremes with liquidity context.
Output: Working scatter plot in Streamlit with real data from CoinGecko, point labels, and color gradient.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (affects this phase):
@.planning/phases/02-coingecko-integration/02-01-SUMMARY.md
@.planning/phases/03-rsi-calculation/03-01-SUMMARY.md

# Key source files:
@src/coingecko.py
@src/rsi.py
@src/charts.py
@app.py
@watchlist.json

**Tech stack available:**
- httpx async client (CoinGeckoClient)
- RSI functions (calculate_rsi, get_daily_rsi, get_weekly_rsi)
- Streamlit + Plotly (in requirements.txt)

**Established patterns:**
- Async context manager for CoinGeckoClient
- asyncio.gather with return_exceptions for concurrent fetching
- RSI returns None for insufficient data

**Constraining decisions:**
- CoinGecko IDs in watchlist (avalanche-2 not avalanche)
- Pure Python RSI (no pandas)
- Wilder's smoothed RSI formula
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement scatter plot builder in charts.py</name>
  <files>src/charts.py</files>
  <action>
Create `build_rsi_scatter()` function that takes coin data and returns a Plotly figure:

Input data structure (list of dicts):
```python
[{
    "symbol": "BTC",
    "name": "Bitcoin",
    "daily_rsi": 45.2,
    "weekly_rsi": 52.1,
    "vol_mcap_ratio": 0.05,  # volume / market_cap
    "price": 42000.0,
    "volume": 25000000000,
    "market_cap": 820000000000
}, ...]
```

Plot specifications:
- X-axis: Daily RSI (0-100 range, label "Daily RSI")
- Y-axis: Vol/MCap ratio (log scale, label "Volume / Market Cap")
- Color: Weekly RSI gradient (0=green, 50=yellow, 100=red) using `RdYlGn_r` colorscale
- Point labels: coin symbol (using text mode)
- Marker size: 12px

Use `go.Scatter` with mode="markers+text", textposition="top center".
Set layout with title "RSI vs Liquidity", fixed x-range [0,100], log y-axis.
Return the figure object (don't show it).

Do NOT add zone shading yet (Phase 5).
  </action>
  <verify>python -c "from src.charts import build_rsi_scatter; print('Import OK')"</verify>
  <done>Function exists, takes list of coin dicts, returns Plotly figure with scatter plot</done>
</task>

<task type="auto">
  <name>Task 2: Wire up app.py with data fetching and chart display</name>
  <files>app.py</files>
  <action>
Replace placeholder UI with working implementation:

1. Load watchlist.json at startup
2. Create async function `fetch_all_data(coin_ids)` that:
   - Creates CoinGeckoClient context
   - Fetches market data (get_coins_market_data)
   - Fetches historical data (get_coins_history with days=90)
   - For each coin, calculate daily_rsi, weekly_rsi, vol_mcap_ratio
   - Returns list of coin data dicts (matching Task 1 format)
   - Skip coins where RSI is None (insufficient data)

3. UI flow:
   - Refresh button (st.button) triggers data fetch
   - Use `asyncio.run()` to call the async function
   - Store results in st.session_state.coin_data
   - Display chart using st.plotly_chart(build_rsi_scatter(data), use_container_width=True)
   - Show "Last updated: {timestamp}" below chart

4. On initial load with no data, show message "Click Refresh to load data"

Use try/except around API calls - show st.error() on failure.
Do NOT add loading spinners yet (Phase 6).
  </action>
  <verify>streamlit run app.py (manual - verify chart appears after clicking Refresh)</verify>
  <done>App loads watchlist, fetches data on Refresh click, displays scatter plot with RSI/liquidity, shows timestamp</done>
</task>

<task type="auto">
  <name>Task 3: Add session state persistence</name>
  <files>app.py</files>
  <action>
Ensure data persists across Streamlit reruns:

1. Initialize session state at top of app (after st.set_page_config):
   ```python
   if "coin_data" not in st.session_state:
       st.session_state.coin_data = None
   if "last_updated" not in st.session_state:
       st.session_state.last_updated = None
   ```

2. On successful fetch, store both coin_data and last_updated timestamp

3. Chart display logic:
   - If st.session_state.coin_data exists, show chart
   - Else show "Click Refresh to load data" message

This ensures chart remains visible after user interactions without refetching.
  </action>
  <verify>python -c "import streamlit as st; print('Streamlit import OK')"</verify>
  <done>Session state initialized, data persists across reruns, chart remains visible after interactions</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.charts import build_rsi_scatter"` succeeds
- [ ] `streamlit run app.py` starts without errors
- [ ] Clicking Refresh fetches data and displays scatter plot
- [ ] Points show coin symbols, colored by weekly RSI
- [ ] Y-axis is log scale
- [ ] Timestamp updates after refresh
- [ ] Chart persists when clicking other Streamlit elements
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors in console
- Scatter plot displays with correct axes and color encoding
- Data persists in session state
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-visualization/04-01-SUMMARY.md` following summary template.
</output>
