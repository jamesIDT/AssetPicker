---
phase: 02-coingecko-integration
plan: 01
type: execute
---

<objective>
Build a complete CoinGecko Pro API client for fetching market data and historical prices.

Purpose: Enable the app to retrieve all data needed for RSI calculation and visualization.
Output: Working `src/coingecko.py` module with async API client, market data fetching, and historical price retrieval.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**From Phase 1 Summary:**
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Key files from Phase 1:**
@src/coingecko.py (placeholder - to be implemented)
@app.py
@.env.example
@watchlist.json

**Tech stack available:** streamlit, plotly, httpx, python-dotenv, pandas
**Established patterns:** src-package-structure, env-based-config

**Constraining decisions:**
- Phase 1: Use httpx over requests for async capability
- Phase 1: CoinGecko IDs in watchlist (e.g., "avalanche-2")

**API Reference (verified):**
- Pro API base URL: `https://pro-api.coingecko.com/api/v3/`
- Auth header: `x-cg-pro-api-key`
- Rate limit: 500 calls/min (Pro tier)
- `/coins/markets` - batch market data (price, volume, mcap)
- `/coins/{id}/market_chart` - historical prices [[timestamp, price], ...]
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CoinGeckoClient class with authentication</name>
  <files>src/coingecko.py</files>
  <action>
Replace placeholder with full implementation:

1. Create `CoinGeckoClient` class with:
   - `__init__(self, api_key: str | None = None)` - load from param or COINGECKO_API_KEY env var
   - `self.base_url = "https://pro-api.coingecko.com/api/v3"`
   - `self.headers = {"x-cg-pro-api-key": api_key}` (only if key provided)
   - httpx.AsyncClient with timeout=30s

2. Add private `_request` method:
   - Async GET with headers
   - Raise `CoinGeckoError` on non-2xx status
   - Return parsed JSON

3. Add custom exception class `CoinGeckoError(Exception)` at module level

4. Use `from dotenv import load_dotenv` and `os.getenv()` for env var loading

Do NOT add rate limiting logic yet - just the basic client structure.
  </action>
  <verify>
```python
from src.coingecko import CoinGeckoClient, CoinGeckoError
client = CoinGeckoClient("test_key")
assert client.base_url == "https://pro-api.coingecko.com/api/v3"
assert "x-cg-pro-api-key" in client.headers
```
  </verify>
  <done>CoinGeckoClient instantiates with API key from param or env, has _request method, CoinGeckoError defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement batch market data fetching</name>
  <files>src/coingecko.py</files>
  <action>
Add method to CoinGeckoClient:

```python
async def get_coins_market_data(self, coin_ids: list[str], vs_currency: str = "usd") -> list[dict]:
    """
    Fetch market data for multiple coins in one request.

    Returns list of dicts with: id, symbol, name, current_price, market_cap, total_volume
    """
```

Implementation:
1. Build URL: `/coins/markets`
2. Params: `vs_currency`, `ids` (comma-joined), `order=market_cap_desc`, `per_page=250`, `sparkline=false`
3. Call `_request` and return response (already list of coin objects)
4. Handle empty coin_ids gracefully (return empty list)

The API already returns the exact fields we need - no transformation required.
  </action>
  <verify>
Method exists with correct signature:
```python
import inspect
from src.coingecko import CoinGeckoClient
sig = inspect.signature(CoinGeckoClient.get_coins_market_data)
assert "coin_ids" in sig.parameters
assert "vs_currency" in sig.parameters
```
  </verify>
  <done>get_coins_market_data method fetches price, volume, market_cap for list of coin IDs</done>
</task>

<task type="auto">
  <name>Task 3: Implement historical price data fetching</name>
  <files>src/coingecko.py</files>
  <action>
Add method to CoinGeckoClient:

```python
async def get_coin_market_chart(self, coin_id: str, vs_currency: str = "usd", days: int = 90) -> dict:
    """
    Fetch historical price data for RSI calculation.

    Returns dict with 'prices', 'market_caps', 'total_volumes' arrays.
    Each array contains [timestamp_ms, value] pairs.
    """
```

Implementation:
1. Build URL: `/coins/{coin_id}/market_chart`
2. Params: `vs_currency`, `days`, `interval=daily` (explicit daily granularity)
3. Call `_request` and return response directly

Also add convenience method:

```python
async def get_coins_history(self, coin_ids: list[str], vs_currency: str = "usd", days: int = 90) -> dict[str, dict]:
    """
    Fetch historical data for multiple coins.
    Returns dict mapping coin_id -> market_chart response.
    """
```

Implementation:
1. Use asyncio.gather to fetch all coins concurrently
2. Return dict mapping coin_id to its market_chart data
3. Handle individual failures gracefully (exclude failed coins from result, don't crash)

Use `asyncio.gather(..., return_exceptions=True)` to handle partial failures.
  </action>
  <verify>
Methods exist with correct signatures:
```python
import inspect
from src.coingecko import CoinGeckoClient
assert hasattr(CoinGeckoClient, 'get_coin_market_chart')
assert hasattr(CoinGeckoClient, 'get_coins_history')
sig = inspect.signature(CoinGeckoClient.get_coin_market_chart)
assert "coin_id" in sig.parameters
assert "days" in sig.parameters
```
  </verify>
  <done>get_coin_market_chart and get_coins_history methods fetch historical prices for RSI calculation</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.coingecko import CoinGeckoClient, CoinGeckoError"` succeeds
- [ ] CoinGeckoClient has all 4 methods: `_request`, `get_coins_market_data`, `get_coin_market_chart`, `get_coins_history`
- [ ] No import errors or syntax errors in module
- [ ] Type hints present on public methods
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- CoinGeckoClient ready for use in app.py
- No TypeScript/Python errors
- Module follows established src-package-structure pattern
</success_criteria>

<output>
After completion, create `.planning/phases/02-coingecko-integration/02-01-SUMMARY.md` following summary template.

Update STATE.md:
- Current Position: Phase 2, Plan 1 complete
- Progress: 33% (2 of 6 phases)

Update ROADMAP.md:
- Phase 2 row: 1/1 plans complete, status "Complete"
</output>
