---
phase: 10-chart-enhancements
plan: 02
type: execute
---

<objective>
Add sector-relative badges and optional z-score labels to the scatter plot.

Purpose: Provide statistical context and sector positioning for individual coins on the main chart.
Output: Best/worst sector badges in tooltips, optional z-score labels next to coin symbols.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-chart-enhancements/10-01-SUMMARY.md

# Source files:
@src/indicators.py
@src/sectors.py
@src/charts.py
@app.py

**Tech stack available:**
- calculate_zscore() in indicators.py
- get_sector(), calculate_sector_rsi() in sectors.py
- Plotly text labels and customdata

**Established patterns:**
- Session state for data persistence
- Layered scatter trace rendering
- Grouped coins by type for trace efficiency
- Toggle controls for optional features (from 10-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calculate sector rankings and z-scores</name>
  <files>app.py</files>
  <action>
Add sector ranking and z-score calculations to fetch_all_data().

1. Calculate sector RSI using calculate_sector_rsi(coins_with_id_and_rsi):
   - Need to pass coin id and daily_rsi for each coin
   - Returns dict of sector -> {rsi, coins, count}

2. For each coin, determine sector ranking:
   - Get coin's sector via get_sector(coin_id)
   - Get all coins in same sector from sector_rsi result
   - Sort by daily_rsi within sector
   - Determine if coin is: "best" (lowest RSI = most oversold), "worst" (highest RSI), or None
   - Only flag best/worst if sector has 2+ coins

3. For each coin, calculate z-score:
   - Need RSI history (already calculated for divergence)
   - Call calculate_zscore(rsi_history, lookback=90)
   - Store result in coin_data["zscore_info"]

4. Add to coin result dict:
   - coin_data["sector"] = sector name
   - coin_data["sector_rank"] = "best" | "worst" | None
   - coin_data["zscore_info"] = zscore dict with zscore value and extreme classification
  </action>
  <verify>Print sector rankings and z-scores for a few coins to verify calculation</verify>
  <done>Each coin has sector, sector_rank, and zscore_info fields populated</done>
</task>

<task type="auto">
  <name>Task 2: Add sector badges to tooltips</name>
  <files>src/charts.py</files>
  <action>
Extend tooltip to show sector info and best/worst badges.

1. Add sector_data parameter to build_rsi_scatter():
   - sector_data: list[dict] | None with keys: sector, sector_rank

2. Update customdata array to include sector info:
   - Add sector name and rank to each coin's customdata
   - Position: after existing fields

3. Update hovertemplate to show sector info:
   - Add line: "Sector: {sector}"
   - If sector_rank is "best": add "üèÜ Best in sector"
   - If sector_rank is "worst": add "‚ö†Ô∏è Worst in sector"

4. Keep badge subtle - just in tooltip, not as visual marker on chart.
  </action>
  <verify>Hover over coins to see sector info and badges in tooltip</verify>
  <done>Tooltips show sector name, best/worst badges appear for appropriate coins</done>
</task>

<task type="auto">
  <name>Task 3: Add optional z-score labels toggle</name>
  <files>app.py, src/charts.py</files>
  <action>
1. In app.py, add checkbox before chart (below color mode toggle):
   ```python
   show_zscore = st.checkbox(
       "Show Z-Score Labels",
       value=False,
       help="Display statistical z-score next to coin symbols for extreme readings (|z| > 1.5)"
   )
   ```

2. Pass show_zscore and zscore_data to build_rsi_scatter()

3. In charts.py, add zscore_data parameter and show_zscore flag:
   - zscore_data: list[dict] | None with zscore values
   - show_zscore: bool = False

4. If show_zscore is True:
   - For coins with |zscore| > 1.5, modify text label to include z-score
   - Format: "BTC (-2.3œÉ)" or "ETH (+1.8œÉ)"
   - Only show for extreme readings to avoid clutter
   - Use textposition that doesn't overlap with existing labels

5. Update tooltip to always show z-score when available:
   - Add line: "Z-Score: -2.3œÉ (Oversold)" or similar
  </action>
  <verify>Toggle z-score labels, verify extreme coins show z-score in label and all coins show in tooltip</verify>
  <done>Z-score toggle works, extreme coins show sigma labels when enabled, tooltip shows z-score for all coins</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -m streamlit run app.py` runs without errors
- [ ] Tooltips show sector name for all coins
- [ ] Best/worst in sector badges appear in tooltips where applicable
- [ ] Z-score toggle shows/hides sigma labels for extreme readings
- [ ] Tooltips include z-score info
- [ ] No visual clutter - labels only appear for significant readings
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Sector badges correctly identify best/worst RSI in each sector
- Z-score labels appear only for |z| > 1.5 to avoid clutter
- No errors or warnings introduced
- Phase 10 complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-chart-enhancements/10-02-SUMMARY.md`
</output>
