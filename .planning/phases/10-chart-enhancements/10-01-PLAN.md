---
phase: 10-chart-enhancements
plan: 01
type: execute
---

<objective>
Add regime banner and color mode toggle with beta-adjusted coloring option.

Purpose: Provide market context at a glance and enable alternative visualization modes for different analysis styles.
Output: Regime banner showing BTC trend, toggle between weekly RSI and beta residual color modes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/07-data-layer-extensions/07-01-SUMMARY.md
@.planning/phases/07-data-layer-extensions/07-02-SUMMARY.md
@.planning/phases/09-visual-markers/09-01-SUMMARY.md

# Source files:
@src/indicators.py
@src/charts.py
@app.py

**Tech stack available:**
- Streamlit for UI controls
- Plotly for chart rendering
- indicators.py has detect_regime(), calculate_beta_adjusted_rsi()

**Established patterns:**
- Session state for data persistence (from Phase 9)
- Layered scatter trace rendering
- Grouped coins by type for trace efficiency
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add regime banner to UI</name>
  <files>app.py</files>
  <action>
After data fetch, calculate BTC regime using detect_regime(). BTC is always "bitcoin" in the watchlist.

1. In fetch_all_data(), after history fetch, extract BTC weekly closes and calculate weekly RSI history
2. Use detect_regime(btc_weekly_rsi_history) to get regime state
3. Store regime in session state: st.session_state.btc_regime

4. Add banner display in main UI, right after title/caption:
   - Use st.container() with custom CSS for banner styling
   - Display regime with emoji and direction arrow:
     - bull_rising: "üêÇ Bull ‚Üó (Rising)"
     - bull_falling: "üêÇ Bull ‚Üò (Cooling)"
     - bear_rising: "üêª Bear ‚Üó (Recovering)"
     - bear_falling: "üêª Bear ‚Üò (Falling)"
     - transition: "‚öñÔ∏è Transition"
   - Background colors: bull=light green, bear=light red, transition=light yellow
   - Show BTC weekly RSI value in banner: "BTC Weekly RSI: 52.3"

Do NOT modify charts.py in this task.
  </action>
  <verify>Run app.py, refresh data, verify banner appears with correct regime and styling</verify>
  <done>Regime banner visible after refresh, shows regime state with emoji and BTC RSI value, styled with appropriate background color</done>
</task>

<task type="auto">
  <name>Task 2: Calculate beta data for all coins</name>
  <files>app.py</files>
  <action>
Add beta-adjusted RSI calculation to fetch_all_data().

1. After fetching history, extract BTC daily returns for beta calculation:
   - btc_prices = history["bitcoin"]["prices"]
   - Calculate returns: (price[i] - price[i-1]) / price[i-1] for each day
   - Store BTC RSI for reference

2. For each coin, calculate beta-adjusted RSI:
   - Extract coin returns from history (same approach)
   - Call calculate_beta_adjusted_rsi(coin_returns, btc_returns, coin_rsi, btc_rsi)
   - Store result in new key: coin_data["beta_info"] = result dict or None

3. The beta_info dict contains: beta, expected_rsi, residual, interpretation
   - residual > 5: outperforming (coin stronger than expected given BTC)
   - residual < -5: underperforming
   - else: expected

4. Add to coin result dict alongside other fields.
  </action>
  <verify>Run app.py, refresh data, print/log beta_info for a few coins to verify calculation</verify>
  <done>Each coin in coin_data has beta_info dict with residual values, None for coins without enough data</done>
</task>

<task type="auto">
  <name>Task 3: Add color mode toggle and dual colorscale</name>
  <files>app.py, src/charts.py</files>
  <action>
1. In app.py, add toggle control before chart:
   ```python
   color_mode = st.radio(
       "Color Mode",
       ["Weekly RSI", "Beta Residual"],
       horizontal=True,
       help="Weekly RSI: Green=oversold, Red=overbought. Beta Residual: Green=outperforming BTC, Red=underperforming."
   )
   ```

2. Pass color_mode to build_rsi_scatter:
   - Add beta_data parameter (list of residual values, same order as coin_data)
   - Pass color_mode string

3. In charts.py, modify build_rsi_scatter():
   - Add parameters: beta_data: list[float] | None = None, color_mode: str = "weekly_rsi"
   - If color_mode == "beta_residual" and beta_data provided:
     - Use residual values for marker color instead of weekly_rsi
     - Colorscale: RdYlGn (NOT reversed - positive residual = green)
     - Adjust cmin/cmax to -20 to 20 (reasonable residual range)
     - Update colorbar title: "Beta Residual"
   - Update customdata to include beta_info for tooltips if available

4. Update hovertemplate to show beta info when in beta mode:
   - Add conditional line: "Beta: {beta:.2f} | Residual: {residual:+.1f}"
  </action>
  <verify>Run app.py, toggle between modes, verify colors change appropriately</verify>
  <done>Toggle visible, colors switch between weekly RSI (green=low RSI) and beta residual (green=outperforming), tooltips show relevant data</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -m streamlit run app.py` runs without errors
- [ ] Regime banner appears with correct styling after data refresh
- [ ] Color mode toggle switches between Weekly RSI and Beta Residual
- [ ] Colorbar updates to show appropriate scale for each mode
- [ ] Tooltips include beta info when in beta mode
</verification>

<success_criteria>
- All tasks completed
- Regime banner shows BTC regime with emoji, arrow, and RSI value
- Toggle control allows switching color modes
- Beta residual coloring shows outperformers in green, underperformers in red
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/10-chart-enhancements/10-01-SUMMARY.md`
</output>
