---
phase: 28-signal-persistence
plan: 01
type: execute
---

<objective>
Build the Signal Persistence Quadrant - a chart showing signal strength vs duration to identify mature "coiled springs" with sustained RSI-price divergence.

Purpose: Surface coins where the RSI-leading-price pattern has persisted over multiple periods (building pressure).
Output: New `build_signal_persistence_quadrant()` function replacing the Phase 28 placeholder, plus persistence tracking in indicators.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-predictive-signal-quadrants/27-CONTEXT.md

**Key insight from CONTEXT.md:**
- X-axis: How strong the RSI-price gap is (divergence magnitude)
- Y-axis: How many periods the gap has persisted
- Top-right quadrant = strongest signals (big gap that's been building)
- Shows both fresh signals (bottom-right) and mature coiled springs (top-right)

**Prior phase context from 27-01-SUMMARY.md:**
- Gap score formula: RSI_accel - Price_accel (positive = RSI leading = bullish)
- price_history (last 10 daily closes) stored in coin data
- price_acceleration data available for each coin
- build_rsi_price_quadrant() pattern established

**Existing patterns to follow:**
@src/indicators.py - calculate_rsi_acceleration(), calculate_price_acceleration()
@src/charts.py - build_rsi_price_quadrant() for quadrant chart construction
@app.py - Placeholder at line 2033-2034 ready to replace

**Established tech:**
- Plotly go.Figure for charts
- Dark theme colors: bg=#4A4F5E, text=#F6F8F7, accent=#B69A5A
- Batch shape updates for performance
- Gap score = RSI_accel - Price_accel
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add signal persistence calculation to indicators.py</name>
  <files>src/indicators.py</files>
  <action>
Add `calculate_signal_persistence(rsi_history: list[float], price_history: list[float], threshold: float = 1.5) -> dict | None` function.

Implementation:
- Requires at least 5 values for each history (oldest to newest)
- For each period i from -5 to -1 (recent history):
  1. Calculate RSI acceleration at period i (need i, i-1, i-2 values)
  2. Calculate price acceleration at period i (need i, i-1, i-2 values)
  3. Calculate gap_score = rsi_accel - price_accel
  4. Track if gap_score exceeds threshold (RSI leading price)
- Count consecutive periods where gap_score > threshold ("persistence")
- Calculate current gap score from latest values
- Return dict with:
  - "current_gap": Current gap score (latest RSI_accel - Price_accel)
  - "persistence": Number of consecutive periods with positive gap (0-5 max)
  - "avg_gap": Average gap score over persistent periods
  - "interpretation": "strong_coiled" | "building" | "weak" | "none"
    - strong_coiled: persistence >= 3 AND current_gap > 3
    - building: persistence >= 2 OR current_gap > 2
    - weak: persistence >= 1 OR current_gap > 1
    - none: no signal
- Return None if insufficient data

This tracks how long the RSI-leading-price pattern has been building.
  </action>
  <verify>python -c "from src.indicators import calculate_signal_persistence; r = calculate_signal_persistence([50,52,55,58,60,62], [100,100.5,101,101.2,101.5,102]); print(r)"</verify>
  <done>Function returns dict with current_gap, persistence, avg_gap, interpretation. Returns None for insufficient data.</done>
</task>

<task type="auto">
  <name>Task 2: Create build_signal_persistence_quadrant() chart function</name>
  <files>src/charts.py</files>
  <action>
Add `build_signal_persistence_quadrant(coins, height=450) -> go.Figure` function.

Implementation following build_rsi_price_quadrant pattern:
1. For each coin:
   - Get "signal_persistence" from coin data (will be populated in Task 3)
   - Extract current_gap (x-axis) and persistence (y-axis)
   - Skip coins missing data

2. Create scatter plot:
   - X-axis: "Signal Strength (Gap Score)" - current gap between RSI and price acceleration
   - Y-axis: "Persistence (Periods)" - how many consecutive periods RSI has led price
   - X range: [-5, 15] to accommodate typical gap scores
   - Y range: [0, 6] for 0-5+ periods persistence

3. Marker styling for visual urgency:
   - Size: 10 + (persistence * 2) - larger for more persistent signals
   - Color: Use gap score with RdYlGn colorscale (positive = green)
   - Add glow effect for top-right coins (high gap + high persistence)

4. Quadrant shading (using batch shapes):
   - Top-Right (Gap > 2, Persistence >= 2): "Mature Signal" - green tint - BEST
   - Bottom-Right (Gap > 2, Persistence < 2): "Fresh Signal" - blue tint
   - Top-Left (Gap <= 2, Persistence >= 2): "Fading" - orange tint
   - Bottom-Left (Gap <= 2, Persistence < 2): "No Signal" - subtle gray

5. Reference lines:
   - Vertical line at x=2 (gap threshold)
   - Horizontal line at y=2 (persistence threshold)

6. Dark theme styling matching existing charts:
   - paper_bgcolor="#4A4F5E", plot_bgcolor="rgba(74, 79, 94, 0.3)"
   - Font color="#F6F8F7"
   - Light grid lines

7. Tooltip with: Symbol, Gap Score, Persistence, Interpretation

8. Annotations for quadrant labels (faint, large text).

Do NOT use individual fig.add_shape() calls - collect shapes in list and use update_layout(shapes=[...]) for performance.
  </action>
  <verify>python -c "from src.charts import build_signal_persistence_quadrant; print('function exists')"</verify>
  <done>Function creates Plotly figure with persistence vs gap scatter, quadrant shading, reference lines, dark theme.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate persistence tracking and quadrant into dashboard</name>
  <files>app.py</files>
  <action>
1. Add import: `build_signal_persistence_quadrant` to the charts import line (already has build_rsi_price_quadrant)

2. Add import: `calculate_signal_persistence` to the indicators imports if not already present

3. In the data processing section (around line 1185 where price_acceleration is calculated):
   - After setting "price_history" for each coin, also calculate signal_persistence:
   ```python
   # Calculate signal persistence (RSI leading price duration)
   if rsi_history and price_history:
       signal_persistence = calculate_signal_persistence(rsi_history, price_history)
   else:
       signal_persistence = None
   ```
   - Add to coin dict: "signal_persistence": signal_persistence

4. Replace the Phase 28 placeholder (around line 2033-2034):
   Change from:
   ```python
   with pred_col2:
       # Placeholder for Phase 28 Signal Persistence Quadrant
       st.info("Signal Persistence Quadrant coming in Phase 28")
   ```
   To:
   ```python
   with pred_col2:
       # Signal Persistence Quadrant
       persistence_fig = build_signal_persistence_quadrant(
           filtered_coin_data,
           height=450,
       )
       if persistence_fig:
           st.plotly_chart(
               persistence_fig,
               use_container_width=True,
               config={"responsive": True, "displayModeBar": False},
           )
       else:
           st.info("Signal persistence requires RSI and price history.")
   ```
  </action>
  <verify>streamlit run app.py (manual check - Signal Persistence Quadrant renders in pred_col2)</verify>
  <done>Phase 28 placeholder replaced with working Signal Persistence Quadrant. Both predictive quadrants visible side-by-side.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from src.indicators import calculate_signal_persistence"` succeeds
- [ ] `python -c "from src.charts import build_signal_persistence_quadrant"` succeeds
- [ ] App runs without errors: `streamlit run app.py`
- [ ] Signal Persistence Quadrant chart renders in right column
- [ ] Points positioned by gap score (x) and persistence (y)
- [ ] Quadrant labels visible (Mature Signal, Fresh Signal, Fading, No Signal)
- [ ] Markers sized by persistence
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Signal Persistence Quadrant displays correctly
- Top-right quadrant highlights mature coiled springs
- Visual urgency increases for high-persistence + high-gap signals
</success_criteria>

<output>
After completion, create `.planning/phases/28-signal-persistence/28-01-SUMMARY.md`
</output>
